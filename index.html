<!DOCTYPE html>
<html>

<head>
    <title>Default Advanced Marker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        #map {
            height: 100%;
            width: 100%;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #legend {
            background: #fff;
            position: absolute;
            bottom: 10px;
            left: 10px;
            padding: 10px;
            margin: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            border-radius: 5px;
            z-index: 11;
            max-width: 90%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .pin-description {
            max-width: 400px;
        }

        .description-container {
            display: flex;
            gap: 10px;
            flex-direction: row;
        }

        .pin-container {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }
    </style>
</head>

<body>

    <div id="legend"></div>
    <div id="map"></div>

    <script>
        (g => {
            var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window;
            b = b[c] || (b[c] = {});
            var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => {
                await (a = m.createElement("script"));
                e.set("libraries", [...r] + "");
                for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
                e.set("callback", c + ".maps." + q);
                a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
                d[q] = f;
                a.onerror = () => h = n(Error(p + " could not load."));
                a.nonce = m.querySelector("script[nonce]")?.nonce || "";
                m.head.append(a)
            }));
            d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n))
        })({ key: "AIzaSyAImnNjxpejsKlQewkCwtBUhyAb560iDSM", v: "weekly" });
    </script>
    <script>
        let map;
        const legendDiv = document.getElementById("legend");
        const allMarkers = [];
        const checkboxes = [];

        async function initMap() {
            // Request needed libraries.
            const { Map, InfoWindow } = await google.maps.importLibrary("maps");
            const { PinElement, AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            map = new Map(document.getElementById("map"), {
                center: { lat: 49.21219633759323, lng: -2.139867639955886 },
                zoom: 12,
                mapId: "4504f8b37365c3d0",
            });

            //--------------------  HIDE ALL --------------------
            addToLegend({
                name: "Hide all", callback: (checked) => {
                    checkboxes.forEach(checkbox => {
                        // checkbox.checked = checked;
                        // checkbox.dispatchEvent(new Event("change"));
                        checkbox.click()
                    });
                }
            });
            // --------------------  Roads --------------------
            // const cycleNetwork = new google.maps.Data();
            // cycleNetwork.loadGeoJson('geodata/cycle_network.geojson');
            // cycleNetwork.setStyle({
            //     strokeColor: 'green',
            //     strokeWeight: 4
            // });
            // cycleNetwork.setMap(map);
            // const cycleNetworkInfo = new google.maps.InfoWindow();
            // cycleNetwork.addListener('click', function (event) {

            // });
            // const cycleCheck = addToLegend({ name: "Cycle network", callback: (checked) => cycleNetwork.setMap(checked ? map : null) });
            // checkboxes.push(cycleCheck.checkbox);
            //--------------------  Roads --------------------

            const mapLayer = new google.maps.Data();
            mapLayer.loadGeoJson('geodata/map.geojson');
            mapLayer.setStyle({
                strokeColor: 'purple',
                strokeWeight: 2
            });
            mapLayer.setMap(map);

            const spreadsheets = [
                { name: "Defibrillators", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0kojLY0DW7hrqrF8q6SqtUx8gxOHg92vMUqw0-jSYennAGu25lGQDPPLWI_hkt63zKQQUV5N_PHCr/pub?gid=989595694&single=true&output=csv", icon: "icons/aed-icon.svg" },
                { name: "Cemeteries", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0kojLY0DW7hrqrF8q6SqtUx8gxOHg92vMUqw0-jSYennAGu25lGQDPPLWI_hkt63zKQQUV5N_PHCr/pub?gid=1362545516&single=true&output=csv", icon: "icons/grave-2-svgrepo-com.svg" },
                { name: "Parks and Gardens", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0kojLY0DW7hrqrF8q6SqtUx8gxOHg92vMUqw0-jSYennAGu25lGQDPPLWI_hkt63zKQQUV5N_PHCr/pub?gid=1961951523&single=true&output=csv", icon: "icons/park-svgrepo-com.svg" },
                { name: "Public Tiolets", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0kojLY0DW7hrqrF8q6SqtUx8gxOHg92vMUqw0-jSYennAGu25lGQDPPLWI_hkt63zKQQUV5N_PHCr/pub?gid=1160438668&single=true&output=csv", icon: "icons/public-toilet-svgrepo-com.svg" },
                { name: "Bike Racks", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0kojLY0DW7hrqrF8q6SqtUx8gxOHg92vMUqw0-jSYennAGu25lGQDPPLWI_hkt63zKQQUV5N_PHCr/pub?gid=460361614&single=true&output=csv", icon: "icons/bicycle-parking-svgrepo-com.svg" },
                { name: "Disabled Parking Spaces", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0kojLY0DW7hrqrF8q6SqtUx8gxOHg92vMUqw0-jSYennAGu25lGQDPPLWI_hkt63zKQQUV5N_PHCr/pub?gid=1564193663&single=true&output=csv" },
                { name: "Unloading Bays", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0kojLY0DW7hrqrF8q6SqtUx8gxOHg92vMUqw0-jSYennAGu25lGQDPPLWI_hkt63zKQQUV5N_PHCr/pub?gid=162926988&single=true&output=csv" },
                { name: "Resident Parking Zones", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0kojLY0DW7hrqrF8q6SqtUx8gxOHg92vMUqw0-jSYennAGu25lGQDPPLWI_hkt63zKQQUV5N_PHCr/pub?gid=230637395&single=true&output=csv" },
                { name: "Roads", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0kojLY0DW7hrqrF8q6SqtUx8gxOHg92vMUqw0-jSYennAGu25lGQDPPLWI_hkt63zKQQUV5N_PHCr/pub?gid=377968935&single=true&output=csv" },
                { name: "Cycle Routes", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0kojLY0DW7hrqrF8q6SqtUx8gxOHg92vMUqw0-jSYennAGu25lGQDPPLWI_hkt63zKQQUV5N_PHCr/pub?gid=1767825220&single=true&output=csv" },
            ]

            //https://developers.google.com/maps/documentation/javascript/reference/info-window#InfoWindowOptions
            const infoWindow = new InfoWindow();

            Promise.all(
                spreadsheets.map(spr => d3.csv(spr.url).then(data => ({ data, name: spr.name, icon: spr.icon })))
            ).then(results => {
                console.log(results);

                const defibrilatorsData = results.find(result => result.name === "Defibrillators");
                const cemeteriesData = results.find(result => result.name === "Cemeteries");
                const parksData = results.find(result => result.name === "Parks and Gardens");
                const publicToiletsData = results.find(result => result.name === "Public Tiolets");
                const bikeRacksData = results.find(result => result.name === "Bike Racks");
                const disabledPrakingSpacesData = results.find(result => result.name === "Disabled Parking Spaces");
                const unloadingBaysData = results.find(result => result.name === "Unloading Bays");
                const residentParkingData = results.find(result => result.name === "Resident Parking Zones");
                const roadsData = results.find(result => result.name === "Roads");
                const cycleData = results.find(result => result.name === "Cycle Routes");


                //----------------- Cycle -----------------
                const cycleGeojson = cycleData.data.map(item => {
                    return {
                        type: "Feature",
                        properties: {
                            name: item["name"],
                            speedLimit: item["speed limit"],
                        },
                        geometry: JSON.parse(item["geometry"])
                    }
                });
                const cycleCollection = {
                    type: "FeatureCollection",
                    features: cycleGeojson
                };
                const cycleLayer = new google.maps.Data();
                cycleLayer.addGeoJson(cycleCollection);
                cycleLayer.setStyle({
                    strokeColor: 'green',
                    strokeWeight: 4
                });
                cycleLayer.setMap(map);
                const cycleInfo = new google.maps.InfoWindow();
                cycleLayer.addListener('click', function (event) {
                    const speedLimit = event.feature.getProperty('speedLimit');
                    const name = event.feature.getProperty('name');
                    const content = `
                        <div><strong>Name:</strong> ${name}</div>
                    `;
                    cycleInfo.setContent(content);
                    cycleInfo.setPosition(event.latLng);
                    cycleInfo.open(map);
                });
                const cycleCheck = addToLegend({ name: cycleData.name, callback: (checked) => cycleLayer.setMap(checked ? map : null) });
                checkboxes.push(cycleCheck.checkbox);

                //----------------- Roads -----------------
                const roadsGeojson = roadsData.data.map(item => {
                    return {
                        type: "Feature",
                        properties: {
                            name: item["name"],
                            speedLimit: item["speed limit"],
                        },
                        geometry: JSON.parse(item["geometry"])
                    }
                });
                const roadsCollection = {
                    type: "FeatureCollection",
                    features: roadsGeojson
                };
                const roadsLayer = new google.maps.Data();
                roadsLayer.addGeoJson(roadsCollection);
                roadsLayer.setStyle({
                    strokeColor: 'blue',
                    strokeWeight: 4
                });
                roadsLayer.setMap(map);
                const roadsInfo = new google.maps.InfoWindow();
                roadsLayer.addListener('click', function (event) {
                    const speedLimit = event.feature.getProperty('speedLimit');
                    const name = event.feature.getProperty('name');
                    const content = `
                        <div><strong>Name:</strong> ${name}</div>
                        <div><strong>Speed limit:</strong> ${speedLimit}</div>
                    `;
                    roadsInfo.setContent(content);
                    roadsInfo.setPosition(event.latLng);
                    roadsInfo.open(map);
                });
                const roadsCheck = addToLegend({ name: roadsData.name, callback: (checked) => roadsLayer.setMap(checked ? map : null) });
                checkboxes.push(roadsCheck.checkbox);

                //----------------- Resident Parking Zones -----------------
                const residentParkingZonesGeojson = residentParkingData.data.map(item => {
                    return {
                        type: "Feature",
                        properties: {
                            name: item["name"],
                            resSpaces: item["residents spaces"],
                            visSpaces: item["visitors spaces"],
                            disSpaces: item["disabled parking spaces"],
                            unldSpaces: item["unloading bays"],
                            docSpaces: item["doctors spaces"],
                            motoSpaces: item["motorcycles spaces"],
                            bicSpaces: item["bicycles spaces"],
                        },
                        geometry: JSON.parse(item["geometry"])
                    }
                });
                const residentParkingZonesCollection = {
                    type: "FeatureCollection",
                    features: residentParkingZonesGeojson
                };
                const residentParkingLayer = new google.maps.Data();
                residentParkingLayer.addGeoJson(residentParkingZonesCollection);
                residentParkingLayer.setStyle(function (feature) {
                    const name = feature.getProperty('name');
                    let strokeColor = 'gray';
                    let fillColor = 'yellow';
                    let fillOpacity = 0.6;
                    console.log('name!!!', feature);
                    switch (name) {
                        case "Richmond Road":
                            strokeColor = 'red';
                            fillColor = '#fbd2d2';
                            break;
                        case `St.Mark's Road`:
                            strokeColor = 'blue';
                            fillColor = '#c1e4f0';
                            break;
                        case `St Thomas'`:
                            strokeColor = 'green';
                            fillColor = '#e8f0cb';
                            break;
                        case `Cheapside'`:
                            strokeColor = 'green';
                            fillColor = 'green';
                            break;
                    }

                    return {
                        strokeColor: strokeColor,
                        strokeWeight: 3,
                        fillColor: fillColor,
                        fillOpacity: fillOpacity
                    };
                });
                residentParkingLayer.setMap(map);

                const residentParkingInfo = new google.maps.InfoWindow();
                residentParkingLayer.addListener('click', function (event) {
                    const numberOfSpaces = event.feature.getProperty('numberOfSpaces');
                    const name = event.feature.getProperty('name');
                    const resSpaces = event.feature.getProperty('resSpaces')
                    const visSpaces = event.feature.getProperty('visSpaces')
                    const disSpaces = event.feature.getProperty('disSpaces')
                    const unldSpaces = event.feature.getProperty('unldSpaces')
                    const docSpaces = event.feature.getProperty('docSpaces')
                    const motoSpaces = event.feature.getProperty('motoSpaces')
                    const bicSpaces = event.feature.getProperty('bicSpaces')
                    const content = `
                        <div><strong>Name:</strong> ${name}</div>
                        <div><strong>residents spaces</strong> ${resSpaces}</div>
                        <div><strong>visitors spaces</strong> ${visSpaces}</div>
                        <div><strong>disabled parking spaces</strong> ${disSpaces}</div>
                        <div><strong>unloading bays</strong> ${unldSpaces}</div>
                        <div><strong>doctors spaces</strong> ${docSpaces}</div>
                        <div><strong>motorcycles spaces</strong> ${motoSpaces}</div>
                        <div><strong>bicycles spaces</strong> ${bicSpaces}</div>
                    `;
                    residentParkingInfo.setContent(content);
                    residentParkingInfo.setPosition(event.latLng);
                    residentParkingInfo.open(map);
                });
                const residentParkingCheck = addToLegend({ name: residentParkingData.name, callback: (checked) => residentParkingLayer.setMap(checked ? map : null) });
                checkboxes.push(residentParkingCheck.checkbox);

                //----------------- Unloading Bays -----------------
                const unloadingBaysGeojson = unloadingBaysData.data.map(item => {
                    return {
                        type: "Feature",
                        properties: {
                            name: item["name"],
                            rpz: item["corresponding rpz"],
                            numberOfSpaces: item["number of spaces"],
                        },
                        geometry: JSON.parse(item["geometry"])
                    }
                });
                const unloadingCollection = {
                    type: "FeatureCollection",
                    features: unloadingBaysGeojson
                };
                const unloadingBaysLayer = new google.maps.Data();
                unloadingBaysLayer.addGeoJson(unloadingCollection);
                unloadingBaysLayer.setStyle({
                    strokeColor: 'orange',
                    strokeWeight: 6
                });
                unloadingBaysLayer.setMap(map);
                const unloadingBaysInfo = new google.maps.InfoWindow();
                unloadingBaysLayer.addListener('click', function (event) {
                    const numberOfSpaces = event.feature.getProperty('numberOfSpaces');
                    const name = event.feature.getProperty('name');
                    const rpz = event.feature.getProperty('rpz');
                    const content = `
                        <div><strong>Name:</strong> ${name}</div>
                        <div><strong>Number of spaces:</strong> ${numberOfSpaces}</div>
                        <div><strong>RPZ:</strong> ${rpz}</div>
                    `;
                    unloadingBaysInfo.setContent(content);
                    unloadingBaysInfo.setPosition(event.latLng);
                    unloadingBaysInfo.open(map);
                });
                const unloadingCheck = addToLegend({ name: unloadingBaysData.name, callback: (checked) => unloadingBaysLayer.setMap(checked ? map : null) });
                checkboxes.push(unloadingCheck.checkbox);

                //----------------- Disabled Parking Spaces -----------------
                const disabledPrakingSpacesGeojson = disabledPrakingSpacesData.data.map(item => {
                    return {
                        type: "Feature",
                        properties: {
                            name: item["name"],
                            rpz: item["corresponding rpz"],
                            numberOfSpaces: item["number of spaces"],
                        },
                        geometry: JSON.parse(item["geometry"])
                    }
                });
                const disabledCollection = {
                    type: "FeatureCollection",
                    features: disabledPrakingSpacesGeojson
                };
                const disabledPrakingSpacesLayer = new google.maps.Data();
                disabledPrakingSpacesLayer.addGeoJson(disabledCollection);
                disabledPrakingSpacesLayer.setStyle({
                    strokeColor: 'green',
                    strokeWeight: 6
                });
                disabledPrakingSpacesLayer.setMap(map);
                const disabledPrakingSpacesInfo = new google.maps.InfoWindow();
                disabledPrakingSpacesLayer.addListener('click', function (event) {
                    const numberOfSpaces = event.feature.getProperty('numberOfSpaces');
                    const name = event.feature.getProperty('name');
                    const rpz = event.feature.getProperty('rpz');
                    const content = `
                        <div><strong>Name:</strong> ${name}</div>
                        <div><strong>Number of spaces:</strong> ${numberOfSpaces}</div>
                        <div><strong>RPZ:</strong> ${rpz}</div>
                    `;
                    disabledPrakingSpacesInfo.setContent(content);
                    disabledPrakingSpacesInfo.setPosition(event.latLng);
                    disabledPrakingSpacesInfo.open(map);
                });
                const disabledCheck = addToLegend({ name: disabledPrakingSpacesData.name, callback: (checked) => disabledPrakingSpacesLayer.setMap(checked ? map : null) });
                checkboxes.push(disabledCheck.checkbox);

                //----------------- Defibrillators -----------------
                const defibrilatorsMarkers = defibrilatorsData.data.map(pin => {
                    const title = "Defibrillator";
                    const icon = defibrilatorsData.icon;
                    const infoWindowContent = `
                            <div>
                                <p>${pin.address}</p>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${pin.latitude},${pin.longitude}" target="_blank">View on Google Maps</a>
                            </div>
                            `;

                    return buildMarker({ icon, pin, title, infoWindowContent })
                });
                allMarkers.push({
                    name: defibrilatorsData.name,
                    markers: defibrilatorsMarkers
                });
                //----------------- Cemeteries -----------------
                const cemeteriesMarkers = cemeteriesData.data.map(pin => {
                    const title = "Cemetery";
                    const icon = cemeteriesData.icon;
                    const img = pin["image url"] ? `<img src="${pin["image url"]}" style="width: 100px; height: 100px;">` : "";
                    const website = pin["website url"] ? `<div><a href="${pin['website url']}" target="_blank">More Details</a></div>` : "";
                    const infoWindowContent = `
                            <div class="pin-container">
                                <div><h1>${pin.name}</h1></div>
                                <div class="description-container">
                                    ${img}
                                    <div class="pin-description">${pin.description}</div>
                                </div>
                                    ${website}
                                <div>
                                    <a href="https://www.google.com/maps/dir/?api=1&destination=${pin.latitude},${pin.longitude}" target="_blank">View on Google Maps</a>
                                </div>
                            </div>
                            `;
                    return buildMarker({ icon, pin, title, infoWindowContent })
                });
                allMarkers.push({
                    name: cemeteriesData.name,
                    markers: cemeteriesMarkers
                });
                //----------------- Parks and Gardens -----------------
                const parksMarkers = parksData.data.map(pin => {
                    const title = "Parks and Gardens";
                    const icon = parksData.icon;
                    const img = pin["image url"] ? `<img src="${pin["image url"]}" style="width: 100px; height: 100px;">` : "";
                    const website = pin["website url"] ? `<div><a href="${pin['website url']}" target="_blank">More Details</a></div>` : "";
                    const infoWindowContent = `
                            <div class="pin-container">
                                <div><h1>${pin.name}</h1></div>
                                <div class="description-container">
                                    ${img}
                                    <div class="pin-description">${pin.description}</div>
                                </div>
                                    ${website}
                                <div>
                                    <a href="https://www.google.com/maps/dir/?api=1&destination=${pin.latitude},${pin.longitude}" target="_blank">View on Google Maps</a>
                                </div>
                            </div>
                            `;
                    return buildMarker({ icon, pin, title, infoWindowContent })
                });
                allMarkers.push({
                    name: parksData.name,
                    markers: parksMarkers
                });
                //----------------- Public Tiolets -----------------
                const publicToilets = publicToiletsData.data.map(pin => {
                    const title = "Public Tiolet";
                    const icon = publicToiletsData.icon;
                    const img = pin["image url"] ? `<img src="${pin["image url"]}" style="width: 100px; height: 100px;">` : "";
                    const website = pin["website url"] ? `<div><a href="${pin['website url']}" target="_blank">More Details</a></div>` : "";
                    const infoWindowContent = `
                            <div class="pin-container">
                                <div><h1>${pin.name}</h1></div>
                                <div class="description-container">
                                    ${img}
                                    <div class="pin-description">${pin.notes}</div>
                                </div>
                                    ${website}
                                <div>
                                    <a href="https://www.google.com/maps/dir/?api=1&destination=${pin.latitude},${pin.longitude}" target="_blank">View on Google Maps</a>
                                </div>
                            </div>
                            `;
                    return buildMarker({ icon, pin, title, infoWindowContent })
                });
                allMarkers.push({
                    name: publicToiletsData.name,
                    markers: publicToilets
                });
                //----------------- Public Tiolets -----------------
                const bikeRacks = bikeRacksData.data.map(pin => {
                    const title = "Public Tiolet";
                    const icon = bikeRacksData.icon;
                    const img = pin["image url"] ? `<img src="${pin["image url"]}" style="width: 100px; height: 100px;">` : "";
                    const website = pin["website url"] ? `<div><a href="${pin['website url']}" target="_blank">More Details</a></div>` : "";
                    const infoWindowContent = `
                            <div class="pin-container">
                                <div><h1>${pin.name}</h1></div>
                                <div class="description-container">
                                    ${img}
                                    <div class="pin-description">
                                        <b>Location:</b> ${pin.location}<br>
                                        <b>Maximum capacity:</b> ${pin['maximum capacity']}<br>
                                        <b>Covered facility:</b> ${pin['covered facility']}<br>
                                    </div>
                                </div>
                                    ${website}
                                <div>
                                    <a href="https://www.google.com/maps/dir/?api=1&destination=${pin.latitude},${pin.longitude}" target="_blank">View on Google Maps</a>
                                </div>
                            </div>
                            `;
                    return buildMarker({ icon, pin, title, infoWindowContent })
                });
                allMarkers.push({
                    name: bikeRacksData.name,
                    markers: bikeRacks
                });


                addLegend(allMarkers);
            });

            function buildMarker({ icon, pin, title, infoWindowContent }) {
                const svgUrl = icon;
                const marker = new AdvancedMarkerElement({
                    map,
                    position: { lat: +pin.latitude, lng: +pin.longitude },
                    content: buildContent(svgUrl),
                    title: pin.info,
                    gmpClickable: true,
                });
                marker.addListener("click", ({ domEvent, latLng }) => {
                    const { target } = domEvent;
                    infoWindow.close();
                    const div = document.createElement("div");
                    div.style = `font-weight:bold;font-size: 16px;`;
                    div.innerHTML = title;
                    infoWindow.setOptions({
                        headerContent: div,
                    });
                    infoWindow.setContent(infoWindowContent);
                    infoWindow.open(marker.map, marker);
                });
                return marker;
            }


            function buildDefibrilatorsMarker({ icon, pin }) {
                const svgUrl = icon;
                const marker = new AdvancedMarkerElement({
                    map,
                    position: { lat: +pin.latitude, lng: +pin.longitude },
                    content: buildContent(svgUrl),
                    title: pin.info,
                    gmpClickable: true,
                });
                marker.addListener("click", ({ domEvent, latLng }) => {
                    const { target } = domEvent;
                    infoWindow.close();
                    const div = document.createElement("div");
                    div.style = `font-weight:bold;font-size: 16px;`;
                    div.innerHTML = "Defibrillator";
                    infoWindow.setOptions({
                        headerContent: div,
                    });
                    infoWindow.setContent(`
                            <div>
                                <p>${pin.address}</p>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${latLng.lat()},${latLng.lng()}" target="_blank">View on Google Maps</a>
                            </div>
                            `);
                    infoWindow.open(marker.map, marker);
                });
                return marker;
            }
        }
        initMap();




        function toggleHighlight(markerView, property) {
            console.log('markerView', markerView);
            if (markerView.content.classList.contains("highlight")) {
                markerView.content.classList.remove("highlight");
                markerView.zIndex = null;
            } else {
                markerView.content.classList.add("highlight");
                markerView.zIndex = 1;
            }
        }

        function buildContent(icon) {
            const content = document.createElement("div");
            content.classList.add("property");
            content.innerHTML = `
                <div class="icon" style="width:30px; height: 30px;">
                    <img src="${icon}" >
                </div>
              
                `;
            return content;
        }

        function addLegend(markersArray) {
            markersArray.forEach(element => {
                const m = addToLegend({
                    name: element.name, callback: (checked) => {
                        element.markers.forEach(marker => {
                            marker.setMap(checked ? map : null);
                        });
                    }
                });
                checkboxes.push(m.checkbox);
            });
        }

        function addToLegend({ name, callback }) {
            const div = document.createElement("div");
            div.style = `display: flex; align-items: center; gap: 5px`;

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = true;
            checkbox.addEventListener("change", () => {
                if (typeof callback === "function") {
                    callback(checkbox.checked);
                }
            });
            const label = document.createElement("label");
            label.textContent = name;
            label.style = `font-size: 14px;`;
            div.appendChild(checkbox);
            div.appendChild(label);
            legendDiv.appendChild(div);

            return {
                checkbox,
            }
        }
    </script>

</body>

</html>